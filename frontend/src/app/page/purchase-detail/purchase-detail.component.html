<div class="container-fluid py-4">
  <!-- Page Header -->
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">{{ pageTitle }}</h1>
    @if (isViewMode && purchase && !purchase.closed) {
      <button 
        class="btn btn-primary" 
        (click)="switchToEditMode()"
        [attr.aria-label]="'Edit purchase #' + purchase.id"
      >
        Edit Purchase
      </button>
    }
  </header>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="row" role="status" aria-live="polite">
      <span class="sr-only">Loading purchase details...</span>
      <div class="col-lg-8">
        <app-card-skeleton [showImage]="false" [textLines]="8" [showAction]="true"></app-card-skeleton>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (error && !isLoading) {
    <app-error-state 
      [message]="error"
      (retry)="retry()"
      actionText="Go Back"
      (action)="goBack()"
    ></app-error-state>
  }

  <!-- Create Mode - Show Form -->
  @if (isCreateMode && !isLoading && !error) {
    <div class="row">
      <div class="col-lg-10 col-xl-8">
        <section class="card" aria-labelledby="create-form-heading">
          <h2 id="create-form-heading" class="sr-only">New Purchase Form</h2>
          <div class="card-body">
            <app-purchase-form
              [purchase]="null"
              [loading]="isSaving"
              (save)="onSave($event)"
              (cancel)="onCancel()"
            ></app-purchase-form>
          </div>
        </section>
      </div>
    </div>
  }

  <!-- Edit Mode - Show Form with Data -->
  @if (isEditMode && purchase && !isLoading && !error) {
    <div class="row">
      <div class="col-lg-10 col-xl-8">
        <section class="card" aria-labelledby="edit-form-heading">
          <h2 id="edit-form-heading" class="sr-only">Edit Purchase Form</h2>
          <div class="card-body">
            @if (purchase.closed) {
              <div class="alert alert-warning mb-4" role="alert">
                <strong>Note:</strong> This purchase is closed and cannot be modified.
              </div>
            }
            <app-purchase-form
              [purchase]="purchase"
              [loading]="isSaving"
              (save)="onSave($event)"
              (cancel)="onCancel()"
            ></app-purchase-form>
          </div>
        </section>
      </div>
    </div>
  }

  <!-- View Mode - Display Only (if we want to add pure view mode later) -->
  @if (isViewMode && purchase && !isLoading && !error) {
    <div class="row">
      <div class="col-lg-8">
        <!-- Purchase Info Card -->
        <section class="card mb-4" aria-labelledby="purchase-info-heading">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h2 id="purchase-info-heading" class="h5 mb-0">Purchase Information</h2>
            <div class="d-flex gap-2">
              <span 
                class="badge"
                [class.bg-success]="purchase.closed"
                [class.bg-warning]="!purchase.closed"
                [attr.aria-label]="'Status: ' + (purchase.closed ? 'Closed' : 'Open')"
              >
                {{ purchase.closed ? 'Closed' : 'Open' }}
              </span>
              <span class="badge bg-secondary" aria-label="Purchase ID">#{{ purchase.id }}</span>
            </div>
          </div>
          <div class="card-body">
            <dl class="row mb-0">
              <div class="col-md-4 mb-3">
                <dt class="form-label text-muted small">Date</dt>
                <dd class="fs-5 mb-0">{{ purchase.date | date:'mediumDate' }}</dd>
              </div>
              <div class="col-md-4 mb-3">
                <dt class="form-label text-muted small">Employee ID</dt>
                <dd class="fs-5 mb-0">{{ purchase.employeeId }}</dd>
              </div>
              <div class="col-md-4 mb-3">
                <dt class="form-label text-muted small">Total</dt>
                <dd class="fs-4 mb-0 text-success fw-bold">{{ purchase.total | currency }}</dd>
              </div>
            </dl>
          </div>
        </section>

        <!-- Purchase Items Table -->
        <section class="card" aria-labelledby="items-heading">
          <div class="card-header">
            <h2 id="items-heading" class="h5 mb-0">Purchase Items</h2>
          </div>
          <div class="card-body p-0">
            @if (purchase.purchaseItems && purchase.purchaseItems.length > 0) {
              <div class="table-responsive" role="region" aria-label="Purchase items list">
                <table class="table table-hover mb-0">
                  <caption class="sr-only">
                    Items in purchase #{{ purchase.id }}. 
                    {{ purchase.purchaseItems.length }} items totaling {{ purchase.total | currency }}.
                  </caption>
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Product ID</th>
                      <th scope="col" class="text-center">Quantity</th>
                      <th scope="col" class="text-end">Unit Price</th>
                      <th scope="col" class="text-end">Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (item of purchase.purchaseItems; track item.productId) {
                      <tr>
                        <td>{{ item.product?.name || ('Product #' + item.productId) }}</td>
                        <td class="text-center">{{ item.quantity }}</td>
                        <td class="text-end">{{ item.product?.price | currency }}</td>
                        <td class="text-end fw-bold">{{ (item.product?.price || 0) * item.quantity | currency }}</td>
                      </tr>
                    }
                  </tbody>
                  <tfoot class="table-light">
                    <tr>
                      <td colspan="3" class="text-end fw-bold">Total:</td>
                      <td class="text-end fw-bold text-success fs-5">{{ purchase.total | currency }}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            } @else {
              <div class="text-center text-muted p-4" role="status">
                No items in this purchase.
              </div>
            }
          </div>
        </section>

        <!-- Actions -->
        <nav class="mt-4" aria-label="Purchase actions">
          <button 
            class="btn btn-outline-secondary" 
            (click)="goBack()"
            aria-label="Go back to purchases list"
          >
            <span aria-hidden="true">‚Üê</span> Go Back
          </button>
        </nav>
      </div>
    </div>
  }
</div>
